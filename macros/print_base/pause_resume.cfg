[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
description: Pause the print and park
variable_restore: {'absolute': {'coordinates': True, 'extrude': True}, 'speed': 1500}
gcode:
    {% set user = printer['gcode_macro _USER_VARIABLES'] %}

    {% set Px, Py = printer["gcode_macro _USER_VARIABLES"].park_position_xy|map('float') %}
    {% set park_lift_z = printer["gcode_macro _USER_VARIABLES"].park_lift_z %}
    {% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
    {% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}

    {% set restore = {'absolute': {'coordinates': printer.gcode_move.absolute_coordinates,
                                 'extrude'    : printer.gcode_move.absolute_extrude },
                    'speed'   : printer.gcode_move.speed } %}
    SET_GCODE_VARIABLE MACRO=PAUSE VARIABLE=restore VALUE="{restore}"
    {% if not printer.extruder.can_extrude %}
      {action_respond_info("Extruder Temp to low heat to %3.1f C" % printer.configfile.settings.extruder.min_extrude_temp)}
      M109 S{printer.configfile.settings.extruder.min_extrude_temp}
    {% endif %}
    G92 E0
    G1 E-{user.filament_retract_pause} F30
    G90
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    _TOOLHEAD_PARK P=0 X={params.X|default(Px)} Y={params.Y|default(Py)}
    M104 S{printer.extruder.target}


[gcode_macro _TOOLHEAD_PARK]
description: Helper: Park toolhead used in PAUSE and CANCEL_PRINT
gcode:
  {% set user = printer['gcode_macro _USER_VARIABLE'] %}
  {% set park_lift_z = printer["gcode_macro _USER_VARIABLES"].park_lift_z %}
  {% set pos = {'x': user.park.bed.x if params.P|int == 1 
                else params.X,
                'y': user.park.bed.y if params.P|int == 1 
                else params.Y,
                'z': user.park.bed.z if params.P|int == 1 
                else [(printer.toolhead.position.z + park_lift_z), printer.toolhead.axis_maximum.z]|min} %}
  G90
  G0 Z{pos.z} F1500
  G0 X{pos.x} Y{pos.y} F4000



[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  {% if printer.ercf.is_paused|int != 0 %}
        M118 You can't resume the print without unlocking the ERCF first.
        M118 Run ERCF_UNLOCK and solve any issue before hitting Resume again
  {% else %}
    {% set user = printer['gcode_macro _USER_VARIABLES'] %}
    {% set restore  = printer["gcode_macro PAUSE"].restore %}
    RESTORE_GCODE_STATE NAME=PAUSE_state
    G90
    {% if printer['ercf'].clog_detection|int == 1 %}
        SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1
    {% endif %}
    RESUME_BASE

    G0 E{user.filament_retract_pause} F30
    G0 F{restore.speed}
  {% endif %}
